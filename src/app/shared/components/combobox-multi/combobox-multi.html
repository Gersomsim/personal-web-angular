<div class="flex flex-col gap-1.5">

	<!-- Label -->
	@if (label()) {
		<label class="font-mono text-xs font-medium text-slate-500 dark:text-slate-400">
			{{ label() }}
		</label>
	}

	<!-- Input + dropdown wrapper -->
	<div class="relative">

		<!-- Input row -->
		<div class="relative">

			<!-- Search icon (left) -->
			<div class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-600">
				<svg class="size-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
				</svg>
			</div>

			<input
				type="text"
				[formControl]="searchControl"
				[placeholder]="effectivePlaceholder()"
				(focus)="onInputFocus()"
				(keydown)="onKeydown($event)"
				role="combobox"
				[attr.aria-expanded]="isOpen()"
				[attr.aria-activedescendant]="activeIndex() >= 0 ? 'multi-option-' + activeIndex() : null"
				aria-autocomplete="list"
				aria-multiselectable="true"
				autocomplete="off"
				spellcheck="false"
				class="w-full rounded-md border py-2 pl-9 pr-16 text-sm text-slate-900 outline-none transition-colors placeholder:text-slate-400 dark:text-white dark:placeholder:text-slate-600"
				[ngClass]="
					isOpen()
						? 'border-emerald-500/50 bg-white dark:bg-slate-900 dark:border-emerald-500/50'
						: 'border-slate-200/50 bg-slate-50 dark:border-slate-800/50 dark:bg-slate-900'
				"
			/>

			<!-- Right side: count badge + chevron -->
			<div class="pointer-events-none absolute right-2.5 top-1/2 flex -translate-y-1/2 items-center gap-1.5">
				<!-- Selected count badge -->
				@if (_selectedItems().length > 0) {
					<span class="flex h-4 min-w-4 items-center justify-center rounded bg-emerald-500/15 px-1 font-mono text-[10px] font-medium text-emerald-600 dark:text-emerald-400">
						{{ _selectedItems().length }}
					</span>
				}
				<!-- Chevron -->
				<div
					class="text-slate-400 transition-transform duration-200 dark:text-slate-600"
					[class.rotate-180]="isOpen()"
				>
					<svg class="size-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
					</svg>
				</div>
			</div>
		</div>

		<!-- Dropdown panel -->
		@if (isOpen()) {
			<div
				role="listbox"
				aria-multiselectable="true"
				class="absolute z-50 mt-1 w-full overflow-hidden rounded-md border border-slate-200/50 bg-white/95 backdrop-blur-sm dark:border-slate-800/50 dark:bg-slate-900/95"
			>
				<!-- Items list -->
				@if (filteredItems().length > 0) {
					<ul class="max-h-52 overflow-y-auto py-1" role="group">
						@for (item of filteredItems(); track item.key; let i = $index) {
							<li
								[id]="'multi-option-' + i"
								role="option"
								[attr.aria-selected]="isSelected(item.key)"
								(click)="toggleItem(item)"
								(mouseenter)="activeIndex.set(i)"
								class="flex cursor-pointer items-center gap-2.5 px-3 py-2 text-sm transition-colors"
								[ngClass]="{
									'bg-emerald-500/10': isSelected(item.key),
									'bg-slate-100 dark:bg-slate-800/70': activeIndex() === i && !isSelected(item.key),
								}"
							>
								<!-- Checkbox indicator -->
								<span
									class="flex size-3.5 shrink-0 items-center justify-center rounded border transition-colors"
									[ngClass]="
										isSelected(item.key)
											? 'border-emerald-500/60 bg-emerald-500/20 text-emerald-600 dark:text-emerald-400'
											: 'border-slate-300/60 dark:border-slate-700/60'
									"
								>
									@if (isSelected(item.key)) {
										<svg class="size-2.5" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
										</svg>
									}
								</span>

								<!-- Item label -->
								<span
									class="flex-1 truncate"
									[ngClass]="
										isSelected(item.key)
											? 'font-medium text-emerald-700 dark:text-emerald-400'
											: 'text-slate-700 dark:text-slate-300'
									"
								>
									{{ item.value }}
								</span>

								<!-- "Quitar" hint on selected hover -->
								@if (isSelected(item.key) && activeIndex() === i) {
									<span class="font-mono text-[10px] text-emerald-500/70 dark:text-emerald-500/50">quitar</span>
								}
							</li>
						}
					</ul>
				}

				<!-- Empty state -->
				@if (filteredItems().length === 0 && !showCreate()) {
					<div class="px-3 py-5 text-center">
						<p class="font-mono text-xs text-slate-400 dark:text-slate-600">
							@if (_inputText().trim()) {
								Sin resultados para "{{ _inputText() }}"
							} @else {
								Escribe para buscar...
							}
						</p>
					</div>
				}

				<!-- Create option: text typed + no match in items list -->
				@if (showCreate()) {
					<div
						[class.border-t]="filteredItems().length > 0"
						class="border-slate-200/50 dark:border-slate-800/50"
					>
						<button
							[id]="'multi-option-' + filteredItems().length"
							type="button"
							role="option"
							(click)="selectCreate()"
							(mouseenter)="activeIndex.set(filteredItems().length)"
							class="flex w-full items-center gap-3 px-3 py-2.5 text-left transition-colors"
							[ngClass]="
								activeIndex() === filteredItems().length ? 'bg-emerald-500/10' : 'hover:bg-emerald-500/5'
							"
						>
							<!-- Plus badge â€” code-style -->
							<span class="flex size-5 shrink-0 items-center justify-center rounded border border-emerald-500/30 bg-emerald-500/10 text-emerald-600 dark:text-emerald-400">
								<svg class="size-3" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
								</svg>
							</span>

							<!-- Create label -->
							<div class="min-w-0">
								<p class="font-mono text-[10px] leading-none text-slate-400 dark:text-slate-600">
									// {{ createLabel() }}
								</p>
								<p class="mt-0.5 truncate text-sm font-medium text-emerald-600 dark:text-emerald-400">
									"{{ _inputText() }}"
								</p>
							</div>
						</button>
					</div>
				}
			</div>
		}
	</div>

	<!-- Selected chips -->
	@if (_selectedItems().length > 0) {
		<div class="flex flex-wrap gap-1.5">
			@for (chip of _selectedItems(); track chip.key) {
				<span class="flex items-center gap-1 rounded-md border border-emerald-500/30 bg-emerald-500/10 py-0.5 pl-2 pr-1 font-mono text-xs text-emerald-600 dark:text-emerald-400">
					{{ chip.value }}
					<button
						type="button"
						(click)="removeChip(chip.key, $event)"
						class="flex size-3.5 items-center justify-center rounded text-emerald-500/70 transition-colors hover:bg-emerald-500/20 hover:text-emerald-700 dark:hover:text-emerald-300"
						[attr.aria-label]="'Quitar ' + chip.value"
					>
						<svg class="size-2.5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
						</svg>
					</button>
				</span>
			}
		</div>
	}

</div>
